<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Magic Notebook</title>
    <style>
      :root {
        --paper-bg: #faf7f2;
        --ink: #2c2a27;
        --accent: #00bcd4;
        --note-bg: #fffdf7;
        --question-bg: #fffbe9;
        --paper-line: rgba(0, 0, 0, 0.06);
      }
      body {
        font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto,
          Helvetica, Arial, sans-serif;
        margin: 0;
        min-height: 100vh;
        color: var(--ink);
        background: linear-gradient(
            180deg,
            rgba(250, 247, 242, 1) 0%,
            rgba(250, 247, 242, 0.6) 100%
          ),
          repeating-linear-gradient(
            #faf7f2,
            #faf7f2 28px,
            #f2ece4 29px,
            #faf7f2 30px
          );
      }
      .page-wrap {
        max-width: 920px;
        margin: 0 auto;
        padding: 24px 20px 40px;
      }
      h1 {
        text-align: center;
        color: var(--ink);
        letter-spacing: 0.3px;
        margin: 8px 0 16px;
        font-weight: 800;
      }
      .notebook {
        background: var(--note-bg);
        border-radius: 12px;
        box-shadow: 0 10px 28px rgba(0, 0, 0, 0.08),
          0 2px 6px rgba(0, 0, 0, 0.06);
        border: 1px solid #eee3d4;
        overflow: hidden;
      }
      .notebook-header {
        padding: 12px 16px;
        background: linear-gradient(
            180deg,
            rgba(255, 255, 255, 0.9),
            rgba(255, 255, 255, 0.7)
          ),
          repeating-linear-gradient(
            90deg,
            transparent,
            transparent 24px,
            rgba(0, 0, 0, 0.05) 25px,
            transparent 26px
          );
        border-bottom: 1px solid #eee3d4;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .spiral {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        border: 2px solid #c0a98e;
        box-shadow: inset 0 0 0 2px #fff;
      }
      .progress-container {
        flex: 1;
        background-color: #f2ece4;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #e6d9c7;
      }
      .progress-bar {
        height: 16px;
        width: 0%;
        background: linear-gradient(90deg, #2ecc71, #00bcd4);
        text-align: right;
        color: white;
        font-size: 11px;
        line-height: 16px;
        padding-right: 6px;
        transition: width 0.5s ease-in-out;
      }
      .content {
        display: grid;
        grid-template-rows: auto 1fr auto auto;
      }
      .chat-container {
        padding: 16px;
        height: 58vh;
        overflow-y: auto;
        background: linear-gradient(
            180deg,
            rgba(255, 255, 255, 0.7),
            rgba(255, 255, 255, 0.6)
          ),
          repeating-linear-gradient(
            #fffdf7,
            #fffdf7 28px,
            var(--paper-line) 29px,
            #fffdf7 30px
          );
      }
      .note {
        background-color: #ffffff;
        padding: 12px 14px;
        margin: 10px 0;
        border-left: 5px solid var(--accent);
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
        animation: inkReveal 0.4s ease-in;
      }
      .question {
        background-color: var(--question-bg);
        padding: 12px 14px;
        margin: 10px 0;
        border-left: 5px solid #ffc107;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
        animation: inkReveal 0.4s ease-in;
      }
      @keyframes inkReveal {
        from {
          opacity: 0;
          transform: translateY(4px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .input-area {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        padding: 12px 16px;
        border-top: 1px dashed #e6d9c7;
        background: #fffaf0;
      }
      .persistent-buttons-area {
        display: flex;
        gap: 10px;
        padding: 12px 16px;
        border-top: 1px solid #eee3d4;
        justify-content: center;
        background: #fffdf7;
      }
      .raw-json-output {
        background-color: #fffaf5;
        padding: 10px;
        border-top: 1px dashed #e0d2be;
        white-space: pre-wrap;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", monospace;
        max-height: 150px;
        overflow: auto;
        color: #5a554d;
      }
      .user-message {
        text-align: right;
        background-color: #e9fff0;
        padding: 6px 8px;
        margin: 8px 0;
        border-right: 3px solid #2ecc71;
        border-radius: 6px;
      }
      .error-message {
        color: #b00020;
        font-weight: 600;
        background-color: #ffe8e8;
        padding: 6px;
        border-left: 3px solid #b00020;
        border-radius: 6px;
        margin: 8px 0;
      }
      button {
        padding: 8px 14px;
        cursor: pointer;
        border: 1px solid #e0d2be;
        background-color: #fff;
        border-radius: 8px;
        color: var(--ink);
        transition: transform 0.05s ease, box-shadow 0.2s ease,
          background 0.2s ease;
        box-shadow: 0 1px 0 rgba(0, 0, 0, 0.04);
      }
      button:hover {
        background-color: #fff6e9;
      }
      button:active {
        transform: translateY(1px);
      }
      input[type="text"] {
        flex-grow: 1;
        padding: 10px 12px;
        border: 1px solid #e0d2be;
        border-radius: 8px;
        background: #fffdf9;
      }
      .rearrange-container {
        border: 1px dashed #d9ccb8;
        padding: 10px;
        min-height: 50px;
        background-color: #fff;
        display: flex;
        flex-direction: column;
        gap: 5px;
        width: 100%;
        border-radius: 8px;
      }
      .rearrange-item {
        background-color: #f3f0ff;
        padding: 8px;
        border: 1px solid #c3c3e6;
        border-radius: 6px;
        cursor: grab;
        user-select: none;
      }
      .rearrange-item.dragging {
        opacity: 0.5;
      }
      canvas {
        touch-action: none;
        background-color: #fff;
        border: 1px solid #d3c8b8;
        max-width: 100%;
        height: auto;
        border-radius: 8px;
      }
      input[type="range"] {
        width: 100%;
        margin: 10px 0;
      }
      input[type="radio"],
      input[type="checkbox"] {
        margin-right: 5px;
      }
      label {
        margin-bottom: 5px;
        display: inline-block;
      }
      .toolbar-label {
        font-weight: 700;
        font-size: 14px;
        margin-right: 6px;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>
    <div class="page-wrap">
      <h1>The Magic Notebook âœ¨</h1>

      <div class="notebook">
        <div class="notebook-header">
          <div class="spiral"></div>
          <div class="toolbar-label">Lesson Progress</div>
          <div class="progress-container">
            <div class="progress-bar" id="lessonProgressBar">0%</div>
          </div>
        </div>

        <div class="content">
          <div class="chat-container" id="chatContainer"></div>
          <div id="dynamicInputArea" class="input-area"></div>
          <div id="persistentButtonsArea" class="persistent-buttons-area"></div>
          <div class="raw-json-output">
            <strong>Raw LLM Response (debug):</strong>
            <pre id="rawOutput"></pre>
          </div>
        </div>
      </div>
    </div>

    <script>
      const sessionId = "{{ session_id }}";
      const chatContainer = document.getElementById("chatContainer");
      const dynamicInputArea = document.getElementById("dynamicInputArea");
      const rawOutputDiv = document.getElementById("rawOutput");
      const lessonProgressBar = document.getElementById("lessonProgressBar");
      const persistentButtonsArea = document.getElementById(
        "persistentButtonsArea"
      );

      let currentStatus = {
        learning_confidence: 5,
        learning_interest: 5,
        learning_patience: 5,
        effort_focus: 10,
        weak_concept_spot: {},
        current_lesson_progress: 0,
        lesson_stage: "not_in_lesson",
        current_lesson_title: "",
        active_question_id: "",
      };

      function updateProgressBar(progress) {
        progress = Math.max(0, Math.min(100, progress || 0));
        lessonProgressBar.style.width = `${progress}%`;
        lessonProgressBar.textContent = `${Math.round(progress)}%`;
      }

      function setupPersistentButtons() {
        persistentButtonsArea.innerHTML = `
          <button id="btnFeedback">Give Feedback</button>
          <button id="btnNextLesson">Next Lesson</button>
          <button id="btnSkipPractice">Skip Practice</button>
          <button id="btnRevealStatus">Reveal My Status</button>
        `;
        document.getElementById("btnFeedback").addEventListener("click", () => {
          // Triggers LLM to ask feedback question UI
          sendActionToBackend("give_feedback", {});
        });
        document
          .getElementById("btnNextLesson")
          .addEventListener("click", () => {
            // Ask LLM to start next lesson (engine should interpret 'next')
            sendActionToBackend("start_lesson", { lesson_index: "next" });
          });
        document
          .getElementById("btnSkipPractice")
          .addEventListener("click", () => {
            sendActionToBackend("skip_practice", {});
          });
        document
          .getElementById("btnRevealStatus")
          .addEventListener("click", () => {
            // Frontend/back-end handle this directly (no LLM needed)
            renderStatusSnapshot();
          });
        updatePersistentButtons();
      }

      function updatePersistentButtons() {
        const stage = currentStatus.lesson_stage;
        const progress = currentStatus.current_lesson_progress;

        const btnFeedback = document.getElementById("btnFeedback");
        const btnNextLesson = document.getElementById("btnNextLesson");
        const btnSkipPractice = document.getElementById("btnSkipPractice");
        const btnRevealStatus = document.getElementById("btnRevealStatus");

        if (btnFeedback) btnFeedback.disabled = false;
        if (btnRevealStatus) btnRevealStatus.disabled = false;

        if (btnNextLesson) {
          btnNextLesson.disabled = !(
            stage === "lesson_complete" || progress >= 95
          );
          btnNextLesson.style.display =
            stage && stage !== "not_in_lesson" ? "inline-block" : "none";
        }

        if (btnSkipPractice) {
          btnSkipPractice.style.display =
            stage === "practice" ? "inline-block" : "none";
        }
      }

      function renderStatusSnapshot() {
        const s = currentStatus;
        const content = `
          <div><strong>Confidence:</strong> ${s.learning_confidence}/10</div>
          <div><strong>Interest:</strong> ${s.learning_interest}/10</div>
          <div><strong>Patience:</strong> ${s.learning_patience}/10</div>
          <div><strong>Focus:</strong> ${s.effort_focus}/10</div>
          <div><strong>Stage:</strong> ${s.lesson_stage}</div>
          <div><strong>Progress:</strong> ${s.current_lesson_progress}%</div>
        `;
        chatContainer.innerHTML += `<div class="note">${content}</div>`;
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      async function sendActionToBackend(command, parameters = {}) {
        const payload = {
          session_id: sessionId,
          user_action: { command, parameters },
        };

        chatContainer.innerHTML += `<div class="user-message"><strong>You:</strong> ${command} ${
          Object.keys(parameters).length ? JSON.stringify(parameters) : ""
        }</div>`;

        try {
          const response = await fetch("/ask", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!response.ok) throw new Error(`HTTP error ${response.status}`);

          const data = await response.json();
          rawOutputDiv.textContent = JSON.stringify(data, null, 2);

          dynamicInputArea.innerHTML = "";

          if (data.current_status) {
            currentStatus = data.current_status;
            updateProgressBar(currentStatus.current_lesson_progress || 0);
            updatePersistentButtons();
          }

          if (data.actions && Array.isArray(data.actions)) {
            for (const action of data.actions) {
              renderUICommand(action);
            }
          } else {
            chatContainer.innerHTML += `<div class="error-message">Invalid AI response format.</div>`;
          }
        } catch (err) {
          console.error("Error:", err);
          chatContainer.innerHTML += `<div class="error-message">Error communicating with AI: ${err.message}</div>`;
        } finally {
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }
      }

      function renderUICommand(action) {
        const params = action.parameters || {};
        switch (action.command) {
          case "ui_display_notes":
            chatContainer.innerHTML += `<div class="note">${marked.parse(
              params.content || ""
            )}</div>`;
            break;
          case "ui_short_answer":
            chatContainer.innerHTML += `<div class="question">${marked.parse(
              params.question_text || ""
            )}</div>`;
            dynamicInputArea.innerHTML = `
              <input type="text" id="${params.variable_name}" placeholder="${
              params.placeholder || ""
            }">
              <button onclick="handleUserInput('${
                params.variable_name
              }', 'text')">Send</button>
            `;
            document.getElementById(params.variable_name)?.focus();
            break;
          case "ui_mcq":
            chatContainer.innerHTML += `<div class="question">${marked.parse(
              params.question_text || ""
            )}</div>`;
            const mcqOptions = (params.options || [])
              .map(
                (opt, idx) =>
                  `<label><input type="radio" name="${params.variable_name}" value="${opt}" id="${params.variable_name}_${idx}"> ${opt}</label><br>`
              )
              .join("");
            dynamicInputArea.innerHTML = `
              <div>${mcqOptions}</div>
              <button onclick="handleUserInput('${params.variable_name}', 'radio')">Submit</button>
            `;
            break;
          case "ui_checkbox":
            chatContainer.innerHTML += `<div class="question">${marked.parse(
              params.question_text || ""
            )}</div>`;
            const cbxOptions = (params.options || [])
              .map(
                (opt, idx) =>
                  `<label><input type="checkbox" name="${params.variable_name}" value="${opt}" id="${params.variable_name}_${idx}"> ${opt}</label><br>`
              )
              .join("");
            dynamicInputArea.innerHTML = `
              <div>${cbxOptions}</div>
              <button onclick="handleUserInput('${params.variable_name}', 'checkbox')">Submit</button>
            `;
            break;
          case "ui_slider":
            chatContainer.innerHTML += `<div class="question">${marked.parse(
              params.question_text || ""
            )}</div>`;
            const defaultVal =
              typeof params.min === "number" && typeof params.max === "number"
                ? params.min
                : 1;
            dynamicInputArea.innerHTML = `
              <input type="range" id="${params.variable_name}" min="${params.min}" max="${params.max}" value="${defaultVal}">
              <div style="display:flex;justify-content:space-between;">
                <span>${params.min}</span>
                <span id="${params.variable_name}_value">${defaultVal}</span>
                <span>${params.max}</span>
              </div>
              <button onclick="handleUserInput('${params.variable_name}', 'slider')">Submit</button>
            `;
            document
              .getElementById(params.variable_name)
              .addEventListener("input", (e) => {
                document.getElementById(
                  `${params.variable_name}_value`
                ).textContent = e.target.value;
              });
            break;
          case "ui_rearrange_order":
            chatContainer.innerHTML += `<div class="question">${marked.parse(
              params.question_text || ""
            )}</div>`;
            const itemsHtml = (params.items || [])
              .map(
                (item, idx) =>
                  `<div class="rearrange-item" draggable="true" data-value="${item}" id="${params.variable_name}_item_${idx}">${item}</div>`
              )
              .join("");
            dynamicInputArea.innerHTML = `
              <div id="${params.variable_name}_container" class="rearrange-container">
                ${itemsHtml}
              </div>
              <input type="hidden" id="${params.variable_name}_ordered_values" value="[]">
              <button onclick="
                const items = Array.from(document.querySelectorAll('#${params.variable_name}_container .rearrange-item')).map(i=>i.dataset.value);
                document.getElementById('${params.variable_name}_ordered_values').value = JSON.stringify(items);
                handleUserInput('${params.variable_name}', 'rearrange_order');
              ">Submit Order</button>
            `;
            const container = document.getElementById(
              `${params.variable_name}_container`
            );
            let draggedItem = null;
            container.addEventListener("dragstart", (e) => {
              draggedItem = e.target;
              if (draggedItem.classList.contains("rearrange-item")) {
                setTimeout(() => draggedItem.classList.add("dragging"), 0);
                e.dataTransfer.effectAllowed = "move";
                e.dataTransfer.setData("text/plain", draggedItem.dataset.value);
              } else {
                e.preventDefault();
              }
            });
            container.addEventListener("dragover", (e) => {
              e.preventDefault();
              const target = e.target;
              if (
                target.classList.contains("rearrange-item") &&
                target !== draggedItem
              ) {
                const rect = target.getBoundingClientRect();
                const offset = rect.y + rect.height / 2;
                if (e.clientY > offset) {
                  container.insertBefore(draggedItem, target.nextSibling);
                } else {
                  container.insertBefore(draggedItem, target);
                }
              }
            });
            container.addEventListener("dragend", () => {
              if (draggedItem) {
                draggedItem.classList.remove("dragging");
                draggedItem = null;
              }
            });
            break;
          case "ui_drawing_board":
            chatContainer.innerHTML += `<div class="question">${marked.parse(
              params.prompt_text || ""
            )}</div>`;
            dynamicInputArea.innerHTML = `
              <canvas id="${params.variable_name}_canvas" width="320" height="180"></canvas>
              <input type="hidden" id="${params.variable_name}_image_data" value="">
              <button onclick="
                const canvas = document.getElementById('${params.variable_name}_canvas');
                const imageData = canvas.toDataURL('image/png');
                document.getElementById('${params.variable_name}_image_data').value = imageData;
                handleUserInput('${params.variable_name}', 'drawing_board');
              ">Submit Drawing</button>
            `;
            const canvas = document.getElementById(
              `${params.variable_name}_canvas`
            );
            const ctx = canvas.getContext("2d");
            let isDrawing = false;
            ctx.lineWidth = 2;
            ctx.lineCap = "round";
            ctx.strokeStyle = "#000";
            const getPos = (e) => {
              const rect = canvas.getBoundingClientRect();
              const clientX = e.touches ? e.touches[0].clientX : e.clientX;
              const clientY = e.touches ? e.touches[0].clientY : e.clientY;
              return { x: clientX - rect.left, y: clientY - rect.top };
            };
            const start = (e) => {
              e.preventDefault();
              isDrawing = true;
              ctx.beginPath();
              const p = getPos(e);
              ctx.moveTo(p.x, p.y);
            };
            const move = (e) => {
              if (!isDrawing) return;
              e.preventDefault();
              const p = getPos(e);
              ctx.lineTo(p.x, p.y);
              ctx.stroke();
            };
            const end = () => {
              isDrawing = false;
            };
            canvas.addEventListener("mousedown", start);
            canvas.addEventListener("mousemove", move);
            canvas.addEventListener("mouseup", end);
            canvas.addEventListener("mouseout", end);
            canvas.addEventListener("touchstart", start);
            canvas.addEventListener("touchmove", move);
            canvas.addEventListener("touchend", end);
            canvas.addEventListener("touchcancel", end);
            break;
          case "ui_button":
            const button = document.createElement("button");
            button.textContent = params.text || "Continue";
            button.addEventListener("click", () => {
              sendActionToBackend(
                params.next_command,
                params.next_command_parameters || {}
              );
            });
            dynamicInputArea.appendChild(button);
            break;
          default:
            chatContainer.innerHTML += `<div class="error-message">Unknown UI Command: ${action.command}</div>`;
        }
      }

      function handleUserInput(variableName, inputType) {
        let value;
        if (inputType === "text") {
          value = document.getElementById(variableName).value;
          if (!value.trim()) {
            alert("Please enter something.");
            return;
          }
        } else if (inputType === "radio") {
          const selected = document.querySelector(
            `input[name="${variableName}"]:checked`
          );
          if (!selected) {
            alert("Please select an option.");
            return;
          }
          value = selected.value;
        } else if (inputType === "checkbox") {
          const selected = document.querySelectorAll(
            `input[name="${variableName}"]:checked`
          );
          if (!selected.length) {
            alert("Please select at least one option.");
            return;
          }
          value = Array.from(selected).map((cb) => cb.value);
        } else if (inputType === "slider") {
          value = document.getElementById(variableName).value;
        } else if (inputType === "rearrange_order") {
          const hidden = document.getElementById(
            `${variableName}_ordered_values`
          );
          if (!hidden || !hidden.value || hidden.value === "[]") {
            alert("Please arrange the items.");
            return;
          }
          try {
            value = JSON.parse(hidden.value);
          } catch {
            alert("Could not process rearrangement.");
            return;
          }
        } else if (inputType === "drawing_board") {
          const hidden = document.getElementById(`${variableName}_image_data`);
          if (!hidden || !hidden.value.trim()) {
            alert("Please draw something.");
            return;
          }
          value = hidden.value;
        }

        let nextCommand;
        let nextParams = {};

        if (variableName === "topic_query") {
          nextCommand = "generate_course_plan";
          nextParams.query = value;
        } else if (variableName === "initial_paraphrase") {
          nextCommand = "evaluate_paraphrase";
          nextParams.user_input = value;
        } else if (variableName === "final_summary") {
          nextCommand = "evaluate_summary";
          nextParams.user_input = value;
        } else if (
          variableName.startsWith("q_lesson") ||
          variableName.startsWith("q_checkpoint_")
        ) {
          nextCommand = "evaluate_answer";
          nextParams.user_answer = value;
          nextParams.question_id = variableName;
        } else if (variableName === "user_feedback_input") {
          nextCommand = "process_feedback";
          nextParams.feedback = value;
        } else {
          nextCommand = "handle_user_question";
          nextParams.user_question_value = value;
          nextParams.input_variable_name = variableName;
          nextParams.input_type = inputType;
        }

        sendActionToBackend(nextCommand, nextParams);
      }

      window.onload = () => {
        const userName =
          prompt("Welcome! What's your name, learner?") || "Learner";
        sendActionToBackend("init", { user_name: userName });
        setupPersistentButtons();
        updateProgressBar(currentStatus.current_lesson_progress);
        updatePersistentButtons();
      };
    </script>
  </body>
</html>
