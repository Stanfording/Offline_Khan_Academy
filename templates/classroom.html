<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Magic Notebook</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 20px;
      }
      .chat-container {
        border: 1px solid #ccc;
        padding: 10px;
        min-height: 200px;
        max-height: 400px;
        overflow-y: scroll;
        margin-bottom: 10px;
        background-color: #f9f9f9;
      }
      .input-area {
        display: flex;
        gap: 5px;
      }
      .raw-json-output {
        background-color: #eee;
        padding: 10px;
        border: 1px dashed #999;
        white-space: pre-wrap;
        font-family: monospace;
      }
      .note {
        background-color: #e0f7fa;
        padding: 10px;
        margin-bottom: 5px;
        border-left: 5px solid #00bcd4;
      }
      .question {
        background-color: #fffde7;
        padding: 10px;
        margin-bottom: 5px;
        border-left: 5px solid #ffeb3b;
      }
      button {
        padding: 8px 15px;
        cursor: pointer;
      }
      input[type="text"] {
        flex-grow: 1;
        padding: 8px;
      }
    </style>
    <!-- IMPORTANT: Add the marked.js CDN script here, or just before your custom script -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>
    <h1>The Magic Notebook âœ¨</h1>
    <div class="chat-container" id="chatContainer">
      <!-- Messages and UI will be rendered here -->
    </div>

    <div id="dynamicInputArea" class="input-area">
      <!-- Dynamic input elements will appear here -->
    </div>

    <div class="raw-json-output">
      <h3>Raw LLM Response (for debug):</h3>
      <pre id="rawOutput"></pre>
    </div>

    <!-- Your custom JavaScript code MUST be within <script> tags like this -->
    <script>
      const sessionId = "{{ session_id }}";
      const chatContainer = document.getElementById("chatContainer");
      const dynamicInputArea = document.getElementById("dynamicInputArea");
      const rawOutputDiv = document.getElementById("rawOutput");

      async function sendActionToBackend(command, parameters = {}) {
        const payload = {
          session_id: sessionId,
          user_action: {
            command: command,
            parameters: parameters,
          },
        };

        chatContainer.innerHTML += `<div class="user-message"><strong>You:</strong> Command '${command}' with params ${JSON.stringify(
          parameters
        )}</div>`;

        try {
          const response = await fetch("/ask", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          rawOutputDiv.textContent = JSON.stringify(data, null, 2); // Display raw JSON for debug

          // Clear previous dynamic input area
          dynamicInputArea.innerHTML = "";

          // Process and render UI commands
          if (data.actions && Array.isArray(data.actions)) {
            for (const action of data.actions) {
              renderUICommand(action);
            }
          } else {
            chatContainer.innerHTML += `<div class="error-message">Error: Invalid response format from AI.</div>`;
          }
        } catch (error) {
          console.error("Error sending action to backend:", error);
          chatContainer.innerHTML += `<div class="error-message">Error communicating with AI: ${error.message}</div>`;
        } finally {
          chatContainer.scrollTop = chatContainer.scrollHeight; // Scroll to bottom
        }
      }

      function renderUICommand(action) {
        const params = action.parameters;
        switch (action.command) {
          case "ui_display_notes":
            chatContainer.innerHTML += `<div class="note">${marked.parse(
              params.content
            )}</div>`;
            break;
          case "ui_short_answer":
            chatContainer.innerHTML += `<div class="question">${marked.parse(
              params.question_text
            )}</div>`;
            dynamicInputArea.innerHTML = `
                        <input type="text" id="${
                          params.variable_name
                        }" placeholder="${params.placeholder || ""}">
                        <button onclick="handleUserInput('${
                          params.variable_name
                        }', 'text')">Send</button>
                    `;
            document.getElementById(params.variable_name).focus();
            break;
          case "ui_mcq":
            chatContainer.innerHTML += `<div class="question">${marked.parse(
              params.question_text
            )}</div>`;
            let optionsHtml = params.options
              .map(
                (opt, index) => `
                        <label><input type="radio" name="${params.variable_name}" value="${opt}" id="${params.variable_name}_${index}"> ${opt}</label><br>
                    `
              )
              .join("");
            dynamicInputArea.innerHTML = `
                        <div>${optionsHtml}</div>
                        <button onclick="handleUserInput('${params.variable_name}', 'radio')">Submit</button>
                    `;
            break;
          case "ui_button":
            dynamicInputArea.innerHTML += `
                        <button onclick="sendActionToBackend('${
                          params.next_command
                        }', ${JSON.stringify(
              params.next_command_parameters || {}
            )})">
                            ${params.text}
                        </button>
                    `;
            break;
          // Add cases for ui_checkbox, ui_slider, ui_rearrange_order, ui_drawing_board as you implement them
          default:
            chatContainer.innerHTML += `<div class="error-message">Unknown UI Command: ${action.command}</div>`;
        }
      }

      function handleUserInput(variableName, inputType) {
        let value;
        if (inputType === "text") {
          value = document.getElementById(variableName).value;
          if (!value.trim()) {
            alert("Please enter something.");
            return;
          }
        } else if (inputType === "radio") {
          const selectedRadio = document.querySelector(
            `input[name="${variableName}"]:checked`
          );
          if (!selectedRadio) {
            alert("Please select an option.");
            return;
          }
          value = selectedRadio.value;
        }
        // Add other input types here (checkbox, slider etc.)

        // Determine the next command based on the variableName
        let nextCommand;
        let nextParams = {};

        if (variableName === "topic_query") {
          nextCommand = "generate_course_plan";
          nextParams.query = value;
        } else if (
          variableName === "initial_paraphrase" ||
          variableName === "final_summary"
        ) {
          nextCommand = "evaluate_paraphrase"; // Can be 'evaluate_summary' too, LLM handles logic
          nextParams.user_input = value;
        } else if (variableName.startsWith("q_lesson")) {
          // Basic logic for practice questions
          nextCommand = "evaluate_answer";
          nextParams.user_answer = value;
          // You'd need to store question_id for actual evaluation.
          // For now, we'll just pass the variable name as a mock question_id if needed.
          // A better approach would be to capture the question_id from the LLM's initial question command.
          nextParams.question_id = variableName;
        } else {
          // Default fallback if no specific logic matches, or if it's a general text input
          nextCommand = "handle_user_question";
          nextParams.user_question = value;
        }

        // Always clear the input area after sending
        dynamicInputArea.innerHTML = "";
        sendActionToBackend(nextCommand, nextParams);
      }

      // On page load, send the initial 'init' command
      window.onload = () => {
        // Get user_name from a prompt or mock it
        const userName =
          prompt("Welcome! What's your name, learner?") || "Learner";
        sendActionToBackend("init", { user_name: userName });
      };
    </script>
  </body>
</html>
